name: Build and Deploy CV

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set Variables and Timestamp
        id: vars
        run: |
          if [ -s filename ]; then
            BASE_NAME=$(cat filename | tr -d '\n\r')
          else
            BASE_NAME="CV"
          fi
          TS=$(date +%A%d%B%Y_%H%M)
          FINAL_NAME="${BASE_NAME}_${TS}"
          echo "FINAL_NAME=$FINAL_NAME" >> $GITHUB_ENV
          echo "pdf_name=$FINAL_NAME" >> $GITHUB_OUTPUT

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          args: -pdf -file-line-error -halt-on-error -interaction=nonstopmode

      - name: Prepare Deployment Directory
        run: |
          # FIX PERMISSIONS: The Docker container creates files as root.
          # We take ownership back so the 'runner' user can modify them.
          sudo chown -R $USER:$USER build
          
          mkdir -p build
          
          # 1. Create the renamed copy
          cp build/main.pdf build/${{ env.FINAL_NAME }}.pdf
          
          # 2. Generate index.html from template
          if [ -f template.html ]; then
            sed "s/{{FILENAME}}/${{ env.FINAL_NAME }}.pdf/g" template.html > build/index.html
          else
            echo "Error: template.html not found!" && exit 1
          fi
          
          # 3. Cleanup auxiliary files (only keep pdf and html)
          find build -type f ! -name '*.pdf' ! -name '*.html' -delete

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/
          retention-days: 1

      - name: Archive Production PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.pdf_name }}
          path: build/${{ steps.vars.outputs.pdf_name }}.pdf
          retention-days: 90

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
